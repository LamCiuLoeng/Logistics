{% extends "master.html" %}

{% block extJS %}

<script src="{{url_for('static', filename='js/customer/deliver_add.js')}}" type="text/javascript"></script>

<script language="JavaScript" type="text/javascript">
//<![CDATA[
	var header_have_update = 0
	
	
	$(document).ready(function(){
		$("input,select,remark",'form').change(function(){
			header_have_update = 1;
		});
	});



	function tosave(){
		var msg = new Array();
		
		if(!$("#supplier_id").val()){
			msg.push('请选择承运商！');
		}
		if(!$("#no").val()){
			msg.push('请填写送货单号码！');
		}
		if(!$("#destination_province_id").val()){
			msg.push('请填写目的地！');
		}
		if(!$("#supplier_contact").val()){
			msg.push('请填写承运商联系人！');
		}
		if(!$("#supplier_tel").val()){
			msg.push('请填写承运商电话！');
		}
		if(!$("#expect_time").val()){
			msg.push('请填写到达预期！');
		}
		if(!$("#amount").val()){
			msg.push('请填写费用！');
		}
		
		var all_cost = true;
		$(".compute").each(function(){
			var tmp = $(this).val();
			if(!tmp || isNaN(tmp)){ all_cost = false; }
		});
		
		if(!all_cost){
			msg.push('请正确填写所有子项目的费用！');
		}
		
		if(msg.length>0){
			show_error(msg.join('<br />'));
		}else{
			show_hold('正在保存，请稍候。。。');
			$("form").submit();
		}
	}
	
	function toreturn(){
		if(header_have_update){
			return redirect_alert("{{MSG_LEAVE_WITHOUT_SAVING}}","{{request.referrer}}");
		}else{
			redirect("{{request.referrer}}");
		}
	}	
	
//]]>
</script>
{% endblock %}


{% block inner_menu %}
<div class="inner_menu">
	<ul>
    	<li><img src="/static/images/system/order_manage_25.jpg" width="71" height="21" id="Image1" onmouseover="MM_swapImage('Image1','','/static/images/system/order_manage_h_25.jpg',1)" onmouseout="MM_swapImgRestore()" onclick="return toreturn();"/></li>
        {% if 'CREATE_DELIVER' is get_permission%}
        <li><input type="image" src="/static/images/system/order_manage_33.jpg" width="77" height="21" id="Image3" onmouseover="MM_swapImage('Image3','','/static/images/system/order_manage_h_33.jpg',1)" onmouseout="MM_swapImgRestore()" onclick="tosave()"/></li>
        {% endif %}
    </ul>
</div>
{% endblock %}
       


{% block content %}
	<div style="background-color: #fff;padding: 10px;">
		
	<form method="post" action="{{url_for('.view',action='deliver_save_new')}}">
		<table border="1" cellpadding="3" cellspacing="3">
			<tbody>
				<tr>
					<td width="100" height="30" align="right">{{_('3rd Party Supplier')}}</td>
					<td width="12">&nbsp;</td>
					<td width="600">
					  <select name="supplier_id" id="supplier_id" class="field order_add_div_body_input must_input" style="width: 200px">
							<option value=""></option>
							{% for s in suppliers %}
								<option value="{{s.id}}">{{s}}</option>
							{% endfor %}
						</select>
					</td>
				<tr>
					<td height="30" align="right">{{_('Destination')}}</td>
					<td>&nbsp;</td>
				  <td>
					<select name="destination_province_id" id="destination_province_id" style="width:150px" class="field order_add_div_body_input must_input" style="width: 150px">
		    	      <option value=""></option>
		    	      {% for p in MASTER_ALL('Province') %}
		    	          <option value="{{p.id}}">{{p}}</option>
		    	      {% endfor %}
		    	  </select>
		    	  <select name="destination_city_id" id="destination_city_id" class="field order_add_div_body_input " style="width: 150px"></select>				  
				  </td>
				</tr>
					<tr>
						<td height="30" align="right">{{_('Deliver Number')}}</td>
						<td>&nbsp;</td>
					  <td><input type="text" name="no" id="no" class="field order_add_div_body_input must_input" style="width: 200px"/></td>
					</tr>
				<tr>
					<td height="30" align="right">{{_('Supplier Contact')}}</td>
					<td>&nbsp;</td>
				  <td><input type="text" name="supplier_contact" id="supplier_contact" class="field order_add_div_body_input must_input" style="width: 200px"/></td>
				</tr>
				<tr>
					<td height="30" align="right">{{_('Supplier Tel')}}</td>
					<td>&nbsp;</td>
				  <td><input type="text" name="supplier_tel" id="supplier_tel" class="field order_add_div_body_input must_input" style="width: 200px"/></td>
				</tr>
				<tr>
					<td height="30" align="right">{{_('Expect Time')}}</td>
					<td>&nbsp;</td>
				  <td><input type="text" name="expect_time" id="expect_time" class="datepicker order_add_div_body_input must_input" style="width: 200px"/></td>
				</tr>
				<tr>
					<td height="30" align="right">总费用</td>
					<td>&nbsp;</td>
				  <td><input type="text" name="amount" id="amount" class="numeric order_add_div_body_input must_input" style="width: 200px"/></td>
				</tr>
				<tr>
					<td height="30" align="right">{{_('Remark')}}</td>
					<td>&nbsp;</td>
				  <td><textarea name="remark" id="remark" class="field" style="width: 200px"></textarea></td>
				</tr>
			</tbody>
		</table>
  <br />
		<br />
		
		<table border="1" cellpadding="3" cellspacing="3" style="width:1200px">
			<thead>
				<tr class="field_head">
					<th style="width:200px">{{_('Order Number')}}</th>
					<th style="width:200px">{{_('Source Station')}}</th>
					<th style="width:200px">{{_('Destination Station')}}</th>
					<th style="width:50px">{{_('Qty')}}</th>
					<th style="width:50px">{{_('Vol')}}</th>
					<th style="width:50px">{{_('Weight')}}</th>
					<th style="width:100px">{{_('Destination Contact')}}</th>
					<th style="width:100px">{{_('Destination Tel')}}</th>
					<th style="width:50px">费用</th>
					<th style="width:150px">{{_('Create Time')}}</th>
					<th style="width:150px">{{_('Creator')}}</th>
				</tr>
			</thead>
			{% for d in result %}		
				<tr class="data_table_tr {{ loop.cycle('data_table_tr_odd', 'data_table_tr_even') }}">
					<th>{{d.ref_no|f}}<input type="hidden" name="detail_{{d.id}}" value="{{d.id}}"/></th>
					<td>{{d.source_province}}{{d.source_city}}</td>
					<td>{{d.destination_province}}{{d.destination_city}}</td>
					<td>{{d.qty|f}}</td>
					<td>{{d.vol|f}}</td>
					<td>{{d.weight|f}}</td>
					<td>{{d.destination_contact|f}}</td>
					<td>{{d.destination_tel|f}}</td>
					<td><input type="text" name="cost_{{d.id}}" value="" class="numeric compute must_input" style="width:80px;text-align:right;"/></td>
					<td>{{d.create_time|ft}}</td>
					<td>{{d.create_by|ifFalse}}</td>
				</tr>
			{% endfor %}
				<tr class="data_table_tr">
					<td colspan="3" style="text-align:left">合计</td>
					<td>{{result|sum_with_none(attribute='qty')}}</td>
					<td>{{result|sum_with_none(attribute='vol')}}</td>
					<td>{{result|sum_with_none(attribute='weight')}}</td>
					<td colspan="2">&nbsp;</td>
					<td><span id="amount_span">0</span></td>
					<td colspan="2">&nbsp;</td>
				</tr>
		</table>
		<br />	
	</form>
	</div>
	
{% endblock %}