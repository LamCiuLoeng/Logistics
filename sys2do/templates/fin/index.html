{% extends "master.html" %}

{% block extCSS %}

{% endblock %}


{% block extJS %}

<script language="JavaScript" type="text/javascript">
//<![CDATA[
	$(document).ready(function(){

	});
	
	
	function toexp(){
		if($("input[name='order_ids']:checked").length < 1){
			show_error('请先选择订单然后再导出！');
			return false;
		}
	
		$("#records").attr('action',"{{ url_for('.view',action='export') }}");
		$("#records").submit();
	}
	
	function allselect(obj){
		var t = $(obj);
		if(t.attr('checked')){
			$("input[type='checkbox'][name='order_ids']").attr('checked','checked');
		}else{
		    $("input[type='checkbox'][name='order_ids']").removeAttr('checked');
		}
	}
	

	function todo_approve(obj){	
		var v = $(":selected",obj).val();
		$(obj).val('');
		if(v){
			return todo('APPROVE',v,function(r){
				if(r.code != 0 ){
					show_error(r.msg);
				}else{
					$("input[name='order_ids']:checked").each(function(){
						var tmp = $(this);
						var tr = $(tmp.parents("tr")[0]);
						if(v=='1'){
							$(".approval_span",tr).text("{{_(ORDER_APPROVED[1])}}");
						}else{
							$(".approval_span",tr).text("{{_(ORDER_DISAPPROVED[1])}}");
						}
					});				
					show_info(r.msg);
				}	
			});
		}
	}
						
	
	function todo_paid(obj){
		var v = $(":selected",obj).val();
		$(obj).val('');
		if(v){
			return todo('PAID',v,function(r){
				if(r.code != 0 ){
					show_error(r.msg);
				}else{
					$("input[name='order_ids']:checked").each(function(){
						var tmp = $(this);
						var tr = $(tmp.parents("tr")[0]);
						if(v=='0'){
							$(".paid_span",tr).text("{{_(ORDER_NOT_PAID[1])}}");
						}else{
							$(".paid_span",tr).text("{{_(ORDER_PAID[1])}}");
						}
					});				
					show_info(r.msg);
				}	
			});
		}
	}
	
	function todo(type,flag,handler){
		var ids = new Array();
		
		$("input[name='order_ids']:checked").each(function(){
			ids.push($(this).val());
		});
		if(ids.length < 1){
			show_error('请先选择订单然后再进行操作！');
			return false;
		}
		
		$.getJSON("{{ url_for('.view',action='ajax_change_flag') }}",
				 {
				 	't' : nowstr(),
				 	'order_ids' : ids.join('|'),
				 	'type' : type,
				 	'flag' : flag
				 },
				 handler
		)
		
		
	}
	
	
//]]>
</script>

{% endblock %}


        
        
{% block inner_menu %}
<div class="inner_menu">
	<ul>
        <li><img src="/static/images/system/order_manage2_35.jpg" width="101" height="21" id="Image7" onmouseover="MM_swapImage('Image7','','/static/images/system/order_manage1_35.jpg',1)" onmouseout="MM_swapImgRestore()" onclick="return toexp();"/></li>
        <li>
        	<select onchange="todo_approve(this);">
        		<option></option>
        		<option value="1">{{_(ORDER_APPROVED[1])}}</option>
        		<option value="2">{{_(ORDER_DISAPPROVED[1])}}</option>
        	</select/>
        </li>
        <li>
        	<select onchange="todo_paid(this);">
        		<option></option>
        		<option value="0">{{_(ORDER_NOT_PAID[1])}}</option>
        		<option value="1">{{_(ORDER_PAID[1])}}</option>
        	</select/>
        </li>
        <li style="padding:0px; margin:0px 55px 0px 0px; float:right"><a href="{{url_for('bpAuth.logout')}}"><img src="/static/images/system/order_manage_22.jpg" width="56" height="29" /></a></li>
    </ul>
</div>
{% endblock %}


{% block content %}
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr><td class="title_fonts_display">&middot; 订单管理</td></tr>
</table>
<div class="search_div">
	<div class="search_div_header">订单搜索</div>
    <div class="search_div_body">
    	<form action="{{url_for('.view')}}" method="post">

    	<ul>
          <li style="width:100%; border-right:#E2FEFE 1px solid;"><span>起始日期</span>
        	  <input type="text" class="datepicker" name="create_time_from" value="{{values.get('create_time_from','')|f}}"/>&nbsp;&nbsp;-&nbsp;&nbsp;<input type="text" class="datepicker" name="create_time_to" value="{{values.get('create_time_to','')|f}}"/>
          </li>
          <li><span>{{_('Order Number')}}</span><input type="text" name="ref_no" value="{{values.get('ref_no','')|f}}"/></li>
          <li style="width:500px"><span>系统编号</span><input type="text" name="no" value="{{values.get('no','')|f}}"/></li>
                 
          <li><span>{{_('Source Station')}}</span><input type="text" name="source_station" value="{{values.get('source_station','')|f}}"/></li>
          <li style="width:500px"><span>{{_('Destination Station')}}</span><input type="text" name="destination_station" value="{{values.get('destination_station','')|f}}"/></li>
          <li style="width:755px"><span>{{_('Source Company')}}</span>
              <select name="source_company_id" id="source_company_id" style="width:400px">
                  <option value=""></option>
                  {% for c in customers%}
                      {% if '%s' % c.id == values.get('source_company_id',None) %}
                          <option value="{{c.id}}" selected="selected">{{c}}</option>
                      {% else %}
                          <option value="{{c.id}}">{{c}}</option>
                      {% endif %}
                  {% endfor %}
          	  </select>
          </li>
          <li style="width:755px"><span>{{_('Destination Company')}}</span>
          		<select name="destination_company_id" id="destination_company_id" style="width:400px">
          		    <option value=""></option>
          		    {% for t in targets %}
          		         {% if '%s' % t.id == values.get('destination_company_id',None)%}
          		             <option value="{{t.id}}" selected="selected">{{t}}</option>
          		         {% else %}
          		             <option value="{{t.id}}">{{t}}</option>
          		         {% endif %}
          		    {% endfor %}
          		</select>
          </li>
        </ul>
        <div class="button_div"><input type="submit" value="{{_('Search')}}"/></div>
    	</form>
        <div style="clear:both"></div>
    </div>
</div>

<div class="point_div"><img src="/static/images/system/order_manage_54.jpg" width="22" height="28" /><span>{{_('Input the conditions and search.')}}</span></div>




<form method="post" action="" id="records">

<table border="0" cellpadding="0" cellspacing="0">
  <tr class="field_head">
    <th align="center" style="width:50px;"><input type="checkbox" onclick="allselect(this);"/></th>
    <td align="center" style="width:200px;">{{_('Order Number')}}</td>
    <td align="center" style="width:200px;">系统编号</td>
    <td align="center" style="width:100px;">{{_('Source Station')}}</td>
    <td align="center" style="width:100px;">{{_('Destination Station')}}</td>
    <td align="center" style="width:300px;">{{_('Source Company')}}</td>
    <td align="center" style="width:300px;">{{_('Destination Company')}}</td>
    <td align="center" style="width:50px;">{{_('Qty')}}</td>
    <td align="center" style="width:50px;">{{_('Weight')}}</td>
    <td align="center" style="width:50px;">{{_('Amount')}}</td>
    <td align="center" style="width:200px;">{{_('Create Time')}}</td>
    <td align="center" style="width:100px;">{{_('Creator')}}</td>
    <td align="center" style="width:150px;">{{_('Status')}}</td>
    <td align="center" style="width:80px;">审核</td>
    <td align="center" style="width:80px;">付款</td>
  </tr>
  
  {% for r in result %}
		  <tr class="data_table_tr {{ loop.cycle('data_table_tr_odd', 'data_table_tr_even') }}">
		    <th><input type="checkbox" name="order_ids" value="{{r.id}}" /></th>
		    <td><a href="{{url_for('.view', action = 'revise',id=r.id)}}">{{r.ref_no|f('没有订单号')}}</a></td>
		    <td>{{r.no|f}}</td>
			<td>{{r.source_station|f}}</td>
			<td>{{r.destination_station|f}}</td>
			<td>{{r.source_company|f}}</td>
			<td>{{r.destination_company|f}}</td>
			<td>{{r.qty|f}}</td>
			<td>{{r.weight|f}}</td>
			<td>{{r.amount|ft}}</td>
			<td>{{r.create_time|ft}}</td>
			<td>{{r.create_by|f}}</td>
			<td>{{r.status|showStatus}}</td>
			<td><span class="approval_span">{{r.approve|showApproval}}</span></td>
			<td><span class="paid_span">{{r.paid|showPaid}}</span></td>
		  </tr>
  {% endfor %}
      <tr class="data_table_tr">
      	<th></th>
      	<td colspan="6" style="text-align:left">&nbsp;合计</td>
      	<td>{{total_qty}}</td>
      	<td>{{total_weight}}</td>
      	<td>{{total_amount}}</td>
      	<td colspan="100">&nbsp;</td>
      </tr>
</table>

</form>


{% endblock %}